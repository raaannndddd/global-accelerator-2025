# Kids Education App Makefile
# This Makefile checks for required tools and runs the development server

.PHONY: help dev check-ollama check-node check-npm install-deps clean

# Default target
help:
	@echo "ğŸŒŸ Kids Learning Adventure - Available Commands:"
	@echo ""
	@echo "  make dev        - Start development server (checks dependencies first)"
	@echo "  make check      - Check if all required tools are installed"
	@echo "  make install    - Install all dependencies"
	@echo "  make clean      - Clean build artifacts"
	@echo "  make help       - Show this help message"
	@echo ""

# Main development target
dev: check-ollama check-node check-npm check-minikit install-deps
	@clear
	@echo "ğŸš€ Starting Kids Learning Adventure development server..."
	@echo "ğŸ“± App will be available at: http://localhost:3000"
	@echo "ğŸ”„ Server will restart automatically on file changes"
	@echo "â¹ï¸  Press Ctrl+C to stop the server"
	@echo ""
	cd nextjs-app && npm run dev

# Check if Ollama is installed and running
check-ollama:
	@echo "ğŸ” Checking Ollama installation..."
	@if ! command -v ollama >/dev/null 2>&1; then \
		echo "âŒ Ollama is not installed!"; \
		echo "ğŸ“¥ Please install Ollama from: https://ollama.ai/"; \
		echo "ğŸ’» Or run: curl -fsSL https://ollama.ai/install.sh | sh"; \
		exit 1; \
	fi
	@echo "âœ… Ollama is installed"
	@echo "ğŸ” Checking if Ollama service is running..."
	@if ! ollama list >/dev/null 2>&1; then \
		echo "âš ï¸  Ollama service is not running. Starting it..."; \
		ollama serve & \
		sleep 3; \
	fi
	@echo "âœ… Ollama service is running"

# Check if Node.js is installed
check-node:
	@echo "ğŸ” Checking Node.js installation..."
	@if ! command -v node >/dev/null 2>&1; then \
		echo "âŒ Node.js is not installed!"; \
		echo "ğŸ“¥ Please install Node.js from: https://nodejs.org/"; \
		echo "ğŸ’» Or use nvm: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash"; \
		exit 1; \
	fi
	@echo "âœ… Node.js is installed (version: $(shell node --version))"

# Check if npm is installed
check-npm:
	@echo "ğŸ” Checking npm installation..."
	@if ! command -v npm >/dev/null 2>&1; then \
		echo "âŒ npm is not installed!"; \
		echo "ğŸ“¥ Please install npm or use a Node.js installer that includes it"; \
		exit 1; \
	fi
	@echo "âœ… npm is installed (version: $(shell npm --version))"

# Check if MiniKit is installed
check-minikit:
	@echo "ğŸ” Checking MiniKit installation..."
	@if ! grep -q "@coinbase/onchainkit" nextjs-app/package.json; then \
		echo "âŒ MiniKit is not installed!"; \
		echo "ğŸ“¥ Installing MiniKit..."; \
		cd nextjs-app && npm install @coinbase/onchainkit; \
	else \
		echo "âœ… MiniKit is already installed"; \
	fi

# Install dependencies
install-deps:
	@echo "ğŸ“¦ Installing dependencies..."
	@if [ ! -d "nextjs-app/node_modules" ]; then \
		echo "ğŸ”„ Installing npm packages..."; \
		cd nextjs-app && npm install; \
	else \
		echo "ğŸ”„ Checking for new dependencies..."; \
		cd nextjs-app && npm install; \
	fi

# Check all requirements
check: check-ollama check-node check-npm check-minikit
	@echo "ğŸ‰ All required tools are installed and ready!"
	@echo "ğŸ“¦ Dependencies: @coinbase/onchainkit, wagmi, viem, pino-pretty"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@if [ -d "nextjs-app/.next" ]; then \
		rm -rf nextjs-app/.next; \
		echo "âœ… Cleaned .next directory"; \
	fi
	@if [ -d "nextjs-app/node_modules" ]; then \
		rm -rf nextjs-app/node_modules; \
		echo "âœ… Cleaned node_modules directory"; \
	fi
	@echo "ğŸ§¹ Cleanup complete!"

# Quick start (alias for dev)
start: dev

# Development with auto-restart (alias for dev)
run: dev

# Deploy to BASE mini app store
deploy:
	@echo "ğŸš€ Deploying Kids Learning Adventure to BASE mini app store..."
	@echo "ğŸ“‹ This will guide you through the deployment process"
	@echo ""
	@if [ -f "deploy.sh" ]; then \
		./deploy.sh; \
	else \
		echo "âŒ deploy.sh not found. Please run the deployment manually:"; \
		echo "1. cd nextjs-app"; \
		echo "2. npm run build"; \
		echo "3. vercel --prod"; \
		echo "4. Set environment variables in Vercel dashboard"; \
		echo "5. Submit to BASE mini app store"; \
	fi
